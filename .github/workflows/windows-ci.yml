name: Windows CI Build (Manual MSVC Setup)

on:
  push:
    branches:
      - 'main'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Qt
        id: install-qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.7.2'
          arch: 'win64_msvc2019_64'
          cached: 'true'

      # ИСПРАВЛЕННЫЙ ШАГ: Настраиваем MSVC вручную, не используя внешний action
      - name: Build with qmake and jom
        shell: cmd # Используем cmd, так как vcvars64.bat - это batch-скрипт
        run: |
          REM Устанавливаем переменные окружения для компилятора MSVC
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"

          REM Добавляем путь к утилитам Qt (jom, windeployqt) в PATH
          set PATH=${{ steps.install-qt.outputs.qtPath }}\bin;%PATH%

          REM Собираем проект
          qmake DubbingTool.pro -spec win32-msvc "CONFIG+=release"
          jom -j%NUMBER_OF_PROCESSORS%

      # Шаг развертывания зависимостей остается тем же, но ему нужно окружение
      - name: Deploy Qt dependencies
        shell: cmd
        run: |
          REM Окружение от vcvars64.bat не сохраняется между шагами,
          REM поэтому нам нужно снова добавить путь к Qt
          set PATH=${{ steps.install-qt.outputs.qtPath }}\bin;%PATH%
          windeployqt.exe --release --no-translations --no-opengl-sw --no-svg --no-network --no-xml release/DubbingTool.exe

      - name: Prepare artifact
        shell: bash
        run: |
          mkdir artifact
          mv release/* artifact/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DubbingTool-Windows-x64
          path: artifact
          retention-days: 7
